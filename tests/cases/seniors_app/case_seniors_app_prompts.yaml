# Physical Only
# CXTB-52: Verify "Personal Care Partner Message" Prompt & Call Back Button.
# CXTB-129: Message Participant's Device - Participant Profile.
TestSeniorAppPersonalCarePartnerMessagePromptAndCallBackButton:
  Environment: Settings
  Vars:
  # Log out option
    LOGOUT_OPTION: "Go Off Shift"
  # Video quality variables
    TIME: 5
    INTERFACE: en0
    VIDEO_IN: "1"
    TEST_FOLDER: $AND_CMD_pwd$/Reports/executions/$AND_CMD_date +%s$
  # Message from Care Partner to Senior
    MESSAGE_TO_PARTICIPANT: Automation Message
  Precases:
    - LoginNeverAloneHelper
    - SeniorCleanPrompts
    - CarePartnerCleanCallQueueAndHangedCalls
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      Capabilities:
        chromeOptions:
          args:
            - use-file-for-fake-audio-capture=$AND_CMD_pwd$/video_audio_samples/sample3.wav
            - use-file-for-fake-video-capture=$AND_CMD_pwd$/video_audio_samples/sample_640x360.mjpeg
      App: desktop
    - Role: command1
      App: command  
  Actions:
  # Send a message to the Senior through the Care Platform logged in as a Care Partner.
    - Type: case
      Value: CarePartnerSendMessageToSenior
  # Device automatically displays "Personal Care Partner Message" window displaying
  # the message sent and indicating the details of who/when sent.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.message_header$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.message_header$
      Attribute: label
      ResultVar: MESSAGE_HEADER_TITLE
    - Type: assert
      Asserts:
        - Type: eq
          Var: MESSAGE_HEADER_TITLE
          Value: Personal Care Partner Message
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.from_label$
    - Type: return_element_attribute
      Strategy: xpath
      Id: $PAGE.seniors_app_message_modal.from_value$
      Attribute: label
      ResultVar: FROM_VALUE
    - Type: assert
      Asserts:
        - Type: eq
          Var: FROM_VALUE
          Value: $AND_CLI_carepartner_user1_name$ $AND_CLI_carepartner_user1_lastname$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.sent_label$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.message_label$
    - Type: return_element_attribute
      Strategy: xpath
      Id: $PAGE.seniors_app_message_modal.message_value$
      Attribute: label
      ResultVar: MESSAGE_VALUE
    - Type: assert
      Asserts:
        - Type: eq
          Var: MESSAGE_VALUE
          Value: $AND_CLI_MESSAGE_TO_PARTICIPANT$
  # Click the "Call Back Personal Care Partner" button.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.call_back_button$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.call_back_button$
      Attribute: label
      ResultVar: CALL_BACK_BUTTON
    - Type: assert
      Asserts:
        - Type: eq
          Var: CALL_BACK_BUTTON
          Value: Call Back Personal Care Partner
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.call_back_button$
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_message_modal.call_back_button$
      Time: 15
  # Device screen updates to show screen asking what kind of need you help:
  # Medical, Non-Medical and Cancel
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.medical_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.non_medical_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.cancel_call_button$
  # Click "Medical" button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.medical_call_button$
  # User is redirected to the waiting room.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.waiting_room_label$
  # Care partner answers call.
    - Type: case
      Value: AnswerCallAsCarePartner
  # Turn on Senior camera.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_button$
  # Verify that a video tumbnail will appear in the upper right corner giving a preview of what the Care Partner is seeing.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_window$
  # Video Quality Step
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_btn$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_mirror_care_partner$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.full_screen_call_btn$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.verify_video_is_full_screen$
    # Record the call.
    - Type: case
      Value: GetCallRecordings
    # Analyze the call.
    - Type: case
      Value: AnalyzeRecordings
    # Make video quality assertions
    - Type: case
      Value: VideoQualityAssertions
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.full_screen_call_btn$
  # Step 6-7 will be skipped
  # These steps are related to XCUI limitations and an existing bug
  # Please refer to the following ticket for more information: https://digitalscientists.atlassian.net/browse/CXTB-317
  # Click "End Call".
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.end_call_button$
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.end_call_button$
  # Fill in the post call survey with the Great option.
    - Type: case
      Value: SeniorGreatPostSurveyCallHelper
  # Care partner tear down
    - Type: case
      Value: PostCallSurveyCarePartner
  # Navigate to Participants.
    - Type: case
      Role: desktopChrome
      Value: CarePartnerNavigateToParticipants
  # Select the corresponding user.
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_participant.senior_complete_name$
  # Right side of screen updates to show the selected participantâ€™s summary component.
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_participant_details.records_button$
  # Click "Records" button at top of participant component on right side of screen.
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_participant_details.records_button$
  # Page refreshes to show the Participant record:
  # Name and DOB at top of left panel.
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_participant_records.participant_name$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_participant_records.participant_dob$
  # Click down arrow next to "Message Participant" (where Participant is their name) on left side.
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_participant_records.message_historical_arrow_button$
  # Verify that the historical messages list has included the message that was just sent.
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_participant_records.last_message_historical$
    - Type: return_element_attribute
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_participant_records.last_message_historical$
      Attribute: textContent
      ResultVar: LAST_MESSAGE_HISTORY
    - Type: assert
      Role: desktopChrome
      Asserts:
        - Type: contain
          Var: LAST_MESSAGE_HISTORY
          Value: $AND_CLI_MESSAGE_TO_PARTICIPANT$

# Physical Only
# CXTB-56: Verify "Answer Call" for Provider Calling.
TestSeniorAppAnswerCallForProviderCalling:
  Environment: Settings
  Vars:
  # Log out option
    LOGOUT_OPTION: "Go Off Shift"
  # Video quality variables
    TIME: 5
    INTERFACE: en0
    VIDEO_IN: "1"
    TEST_FOLDER: $AND_CMD_pwd$/Reports/executions/$AND_CMD_date +%s$
  Precases:
    - LoginNeverAloneHelper
    - SeniorCleanPrompts
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      Capabilities:
        chromeOptions:
          args:
            - use-file-for-fake-audio-capture=$AND_CMD_pwd$/video_audio_samples/sample3.wav
            - use-file-for-fake-video-capture=$AND_CMD_pwd$/video_audio_samples/sample_640x360.mjpeg
      App: desktop
    - Role: command1
      App: command  
  Actions:
  # Call participant(Senior) logged in as a Provider.
    - Type: case
      Value: ProviderCallParticipant
  # Device begins ringing and automatically displays "Incoming Call" modal.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
      Attribute: label
      ResultVar: HEADER_TITLE
    - Type: assert
      Asserts:
        - Type: eq
          Var: HEADER_TITLE
          Value: Incoming Call...
  # Verify that it shows who is calling and their details, giving you the option to answer or ignore the call.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
      Attribute: label
      ResultVar: CALLER_VALUE
    - Type: assert
      Asserts:
        - Type: eq
          Var: CALLER_VALUE
          Value: Dr. $AND_CLI_provider_user1_name$ $AND_CLI_provider_user1_lastname$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.answer_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
  # Click "Answer Call" button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.answer_call_button$
  # Verify that senior was connected to the call.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_button$
  # Turn on Senior camera.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_button$
  # Verify that a video tumbnail will appear in the upper right corner giving a preview of what the Care Partner is seeing.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_window$
  # Video Quality Step
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_btn$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_mirror_care_partner$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.full_screen_call_btn$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.verify_video_is_full_screen$
    # Record the call.
    - Type: case
      Value: GetCallRecordings
    # Analyze the call.
    - Type: case
      Value: AnalyzeRecordings
    # Make video quality assertions
    - Type: case
      Value: VideoQualityAssertions
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.full_screen_call_btn$
  # Then click "End Call".
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.end_call_button$
  # Select the Great option on the Post Call Survey once the call ends.
    - Type: case
      Value: SeniorGreatPostSurveyCallHelper
  # Fill up the Post Call Survey on the provider side.
    - Type: case
      Value: PostCallSurveyProvider

# CXTB-53: Verify Ignore Call for Care Partner on Never Alone Seniors app.
TestSeniorAppIgnoreCarePartnerCall:
  Environment: Settings
  Precases:
    - LoginNeverAloneHelper
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      App: desktop    
  Actions:
  # Log in as a Care Partner and Call Senior.
    - Type: case
      Value: CarePartnerCallSenior
  # Device begins ringing and automatically displays "Incoming Call" modal.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
      Attribute: label
      ResultVar: HEADER_TITLE
    - Type: assert
      Asserts:
        - Type: eq
          Var: HEADER_TITLE
          Value: Incoming Call...
  # Verify that it shows who is calling and their details, giving you the option to answer or ignore the call.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
      Attribute: label
      ResultVar: CALLER_VALUE
    - Type: assert
      Asserts:
        - Type: eq
          Var: CALLER_VALUE
          Value: $AND_CLI_carepartner_user1_name$ $AND_CLI_carepartner_user1_lastname$ Personal Care Partner
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.answer_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
  # Click the "Ignore Call" button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
  # Verify that the device returns you to the screen without entering the call.
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
      Time: 10
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_button$
      Time: 10

# CXTB-57: Verify Ignore Call for Provider on Never Alone Seniors app.
TestSeniorAppIgnoreProviderCall:
  Environment: Settings
  Precases:
    - LoginNeverAloneHelper
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      App: desktop
  Actions:
  # Call participant(Senior) logged in as a Provider.
    - Type: case
      Value: ProviderCallParticipant
  # Device begins ringing and automatically displays "Incoming Call" modal.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
      Attribute: label
      ResultVar: HEADER_TITLE
    - Type: assert
      Asserts:
        - Type: eq
          Var: HEADER_TITLE
          Value: Incoming Call...
  # Verify that it shows who is calling and their details, giving you the option to answer or ignore the call.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
      Attribute: label
      ResultVar: CALLER_VALUE
    - Type: assert
      Asserts:
        - Type: eq
          Var: CALLER_VALUE
          Value: Dr. $AND_CLI_provider_user1_name$ $AND_CLI_provider_user1_lastname$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.answer_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
  # Click the "Ignore Call" button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
  # Verify that the device returns you to the screen without entering the call.
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
      Time: 10
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_button$
      Time: 10

# Physical Device Only
# CXTB-53: Verify Answer Call for Care Partner on Never Alone Seniors app.
TestSeniorAppAnswerCallCarePartnerCall:
  Environment: Settings
  Vars:
  # Video quality variables
    TIME: 5
    INTERFACE: en0
    VIDEO_IN: "1"
    TEST_FOLDER: $AND_CMD_pwd$/Reports/executions/$AND_CMD_date +%s$
  Precases:
    - LoginNeverAloneHelper
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      Capabilities:
        chromeOptions:
          args:
            - use-file-for-fake-audio-capture=$AND_CMD_pwd$/video_audio_samples/sample3.wav
            - use-file-for-fake-video-capture=$AND_CMD_pwd$/video_audio_samples/sample_640x360.mjpeg
      App: desktop
    - Role: command1
      App: command     
  Actions:
  # Log in as a Care Partner and Call Senior.
    - Type: case
      Value: CarePartnerCallSenior
  # Device begins ringing and automatically displays "Incoming Call" modal.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
      Attribute: label
      ResultVar: HEADER_TITLE
    - Type: assert
      Asserts:
        - Type: eq
          Var: HEADER_TITLE
          Value: Incoming Call...
  # Verify that it shows who is calling and their details, giving you the option to answer or ignore the call.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
      Attribute: label
      ResultVar: CALLER_VALUE
    - Type: assert
      Asserts:
        - Type: eq
          Var: CALLER_VALUE
          Value: $AND_CLI_carepartner_user1_name$ $AND_CLI_carepartner_user1_lastname$ Personal Care Partner
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.answer_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
  # Click "Answer Call" button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.answer_call_button$
  # Verify user is now on an active call screen.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_button$
  # Turn on Senior camera.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_button$
  # Verify that a video tumbnail will appear in the upper right corner giving a preview of what the Care Partner is seeing.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_window$
  # Video Quality Step
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_btn$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_mirror_care_partner$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.full_screen_call_btn$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.verify_video_is_full_screen$
    # Record the call.
    - Type: case
      Value: GetCallRecordings
    # Analyze the call.
    - Type: case
      Value: AnalyzeRecordings
    # Make video quality assertions
    - Type: case
      Value: VideoQualityAssertions
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.full_screen_call_btn$
  # Then click "End Call".
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.end_call_button$
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.end_call_button$
  # Select the Great option on the Post Call Survey once the call ends.
    - Type: case
      Value: SeniorGreatPostSurveyCallHelper
  # Fill up the Post Call Survey on the provider side.
    - Type: case
      Value: PostCallSurveyCarePartner